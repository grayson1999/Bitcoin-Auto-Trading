# Feature Specification: AI 신호 프롬프트 최적화

**Feature Branch**: `001-signal-prompt-optimization`
**Created**: 2026-01-24
**Status**: Draft
**Input**: docs/SIGNAL_OPTIMIZATION_PLAN.md 기반

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 더 빈번한 매매 신호 수신 (Priority: P1)

트레이더는 시장 변동성에 더 빠르게 대응하기 위해 1시간이 아닌 30분마다 AI 매매 신호를 받고 싶다. 급등/급락 상황에서 1시간을 기다리면 기회를 놓치거나 손실이 커질 수 있기 때문이다.

**Why this priority**: 변동성이 높은 암호화폐 시장에서 신호 생성 주기는 수익성과 직결됨. 현재 1시간 주기로는 급격한 가격 변동에 대응하기 어려움.

**Independent Test**: 신호 생성 주기를 30분으로 변경하고, 하루 동안 48회 신호가 생성되는지 확인하여 테스트 가능.

**Acceptance Scenarios**:

1. **Given** 시스템이 정상 운영 중일 때, **When** 30분이 경과하면, **Then** 새로운 AI 매매 신호가 생성된다.
2. **Given** 이전 신호 생성 후 29분이 경과했을 때, **When** 시장에 급격한 변동이 발생해도, **Then** 예정된 30분 주기까지 기다린 후 신호가 생성된다.
3. **Given** 하루가 시작될 때, **When** 24시간이 경과하면, **Then** 총 48회의 신호가 생성되어 있다.

---

### User Story 2 - 비용 효율적인 AI 호출 (Priority: P1)

시스템 운영자는 AI 호출 비용을 절감하면서도 신호 빈도를 2배로 늘리고 싶다. 현재 프롬프트가 너무 길어서 토큰 비용이 과다하게 발생하고 있다.

**Why this priority**: 비용 절감은 서비스 지속 가능성에 직결됨. 신호 빈도 2배 증가에도 총 비용이 현재 수준 이하로 유지되어야 함.

**Independent Test**: AI 호출 시 입력 토큰 수를 측정하여 기존 대비 60% 감소 여부 확인.

**Acceptance Scenarios**:

1. **Given** AI 신호 생성 요청 시, **When** 프롬프트가 구성되면, **Then** 입력 토큰 수가 4,000개 이하이다.
2. **Given** 하루 동안 48회 신호 생성 시, **When** 일일 비용을 계산하면, **Then** 기존 24회 생성 비용(약 480원) 이하이다.
3. **Given** 프롬프트가 최적화된 상태에서, **When** AI 응답 시간을 측정하면, **Then** 2-4초 내에 응답을 받는다.

---

### User Story 3 - 시장 데이터 샘플링 (Priority: P2)

시스템은 AI 분석에 필요한 시장 데이터를 효율적으로 샘플링하여 전달해야 한다. 10초마다 수집되는 모든 데이터를 전달하면 토큰이 낭비되므로, 시간대별로 적절한 간격으로 샘플링한다.

**Why this priority**: 데이터 샘플링은 토큰 절감의 핵심 전략이며, P1의 비용 효율성 달성에 필수적임.

**Independent Test**: 프롬프트에 포함된 시장 데이터 개수가 샘플링 정책에 맞게 줄어드는지 확인.

**Acceptance Scenarios**:

1. **Given** 장기 추세 분석이 필요할 때, **When** 14일치 데이터를 조회하면, **Then** 1시간 간격으로 샘플링된 약 336개 데이터만 포함된다.
2. **Given** 중기 변동성 분석이 필요할 때, **When** 24시간 데이터를 조회하면, **Then** 15분 간격으로 샘플링된 약 96개 데이터만 포함된다.
3. **Given** 단기 가격 흐름 분석이 필요할 때, **When** 1시간 데이터를 조회하면, **Then** 5분 간격으로 샘플링된 약 12개 데이터만 포함된다.

---

### User Story 4 - 정확한 신뢰도 점수 (Priority: P2)

트레이더는 AI 신호의 신뢰도를 명확한 기준으로 받고 싶다. 현재는 AI가 조건이 불명확할 때 기본값 0.5를 출력하는 경우가 많아 신뢰도 정보의 의미가 퇴색됨.

**Why this priority**: 신뢰도는 트레이더의 의사결정에 중요한 정보이며, 명확한 계산 기준이 있어야 신호를 신뢰할 수 있음.

**Independent Test**: 다양한 시장 상황에서 신뢰도가 명시된 공식에 따라 계산되는지 확인.

**Acceptance Scenarios**:

1. **Given** 손절 조건이 충족되었을 때, **When** AI가 SELL 신호를 생성하면, **Then** 신뢰도는 0.9로 출력된다.
2. **Given** 4개 시간 프레임이 모두 상승 추세일 때, **When** AI가 BUY 신호를 생성하면, **Then** 기본값에 +0.15 보너스가 적용된다.
3. **Given** 특별한 조건이 없을 때, **When** AI가 HOLD 신호를 생성하면, **Then** 신뢰도는 0.5로 출력된다.

---

### User Story 5 - 성과 피드백 제거 (Priority: P3)

시스템 운영자는 프롬프트에서 성과 피드백 섹션을 제거하여 토큰을 절약하고 싶다. 성과 데이터는 대시보드에서 별도로 확인할 수 있으므로 AI에게 매번 전달할 필요가 없다.

**Why this priority**: 성과 피드백은 약 500 토큰을 차지하며, 대시보드에서 동일 정보를 확인할 수 있어 중복됨.

**Independent Test**: 프롬프트에서 성과 피드백 섹션이 제거되고, 대시보드에서 성과 데이터가 정상 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** AI 신호 생성 요청 시, **When** 프롬프트가 구성되면, **Then** 성과 피드백 섹션이 포함되지 않는다.
2. **Given** 트레이더가 대시보드에 접속할 때, **When** 성과 데이터를 확인하면, **Then** 일일/누적 손익이 정상적으로 표시된다.

---

### Edge Cases

- 시장 데이터가 불충분할 때 (예: 시스템 장애로 데이터 수집 중단) 어떻게 처리하는가?
  - 최소 1시간 분량의 데이터가 있으면 신호 생성 진행, 없으면 생성 스킵
- AI 응답이 JSON 형식에 맞지 않을 때 어떻게 처리하는가?
  - 파싱 실패 시 HOLD 신호로 대체하고 경고 로그 기록
- 신뢰도 계산에서 값이 1.0을 초과할 때 어떻게 처리하는가?
  - 최댓값 1.0으로 클램핑

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 30분 간격으로 AI 매매 신호를 생성해야 한다.
- **FR-002**: 시스템은 AI 프롬프트 입력 토큰을 4,000개 이하로 유지해야 한다.
- **FR-003**: 시스템은 시장 데이터를 시간대별로 샘플링하여 AI에게 전달해야 한다.
  - 장기 (14일): 1시간 간격
  - 중기 (24시간): 15분 간격
  - 단기 (1시간): 5분 간격
- **FR-004**: 시스템은 AI 프롬프트에서 성과 피드백 섹션을 제거해야 한다.
- **FR-005**: AI는 명시적 공식에 따라 신뢰도를 계산해야 한다.
  - 기본값: 손절 0.9, 익절 0.85, 매수 0.6, HOLD 0.5
  - 보너스: 4TF 일치 +0.15, 3TF +0.10, 2TF +0.05
  - 지표 보너스: RSI 극단 +0.05, MACD+BB 일치 +0.05
- **FR-006**: 시스템은 신호 생성 시 신뢰도 계산 근거를 함께 출력해야 한다.
- **FR-007**: 시스템은 AI 응답 시간을 4초 이내로 유지해야 한다.

### Key Entities

- **TradingSignal**: AI가 생성한 매매 신호 (BUY/HOLD/SELL, 신뢰도, 생성 시간, 근거)
- **MarketDataSample**: 샘플링된 시장 데이터 (시간대, 가격, 거래량, 샘플링 간격)
- **ConfidenceBreakdown**: 신뢰도 계산 내역 (기본값, TF 보너스, 지표 보너스)

### Assumptions

- 기존 시세 수집 주기(10초)는 변경하지 않음
- 대시보드에서 성과 데이터 조회 기능은 이미 구현되어 있음
- AI 모델(Gemini 2.5 Pro)은 변경하지 않음
- 기존 MTF Analyzer의 지표 계산 로직은 유지

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 신호 생성 주기가 30분으로 변경되어 하루 48회 신호가 생성된다.
- **SC-002**: AI 호출당 입력 토큰이 기존 10,000개에서 4,000개로 60% 감소한다.
- **SC-003**: 하루 48회 신호 생성 시 총 비용이 기존 24회 비용(약 480원) 이하로 유지된다.
- **SC-004**: AI 응답 시간이 기존 5-8초에서 2-4초로 50% 단축된다.
- **SC-005**: 신뢰도 0.5 고정 출력 비율이 기존 대비 50% 이상 감소한다.
- **SC-006**: 프롬프트에 포함된 시장 데이터가 기존 1,000개에서 약 450개로 55% 감소한다.
