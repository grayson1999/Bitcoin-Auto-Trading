# Feature Specification: Backend 성능 최적화

**Feature Branch**: `002-backend-performance`
**Created**: 2026-01-24
**Status**: Draft
**Input**: docs/OPTIMIZATION_REPORT.md 기반 성능 최적화 항목

## Clarifications

### Session 2026-01-24

- Q: DB 커넥션 풀 목표 크기? → A: 10/20 (min/max)
- Q: 스케줄러 재시도 전략? → A: 지수 백오프 3회 재시도 (1초→2초→4초)
- Q: 상세 헬스체크 구성요소? → A: 6개 (DB, Upbit API, Gemini API, 스케줄러, 최근 신호, 최근 주문)
- Q: 메트릭 저장 방식? → A: 구조화된 JSON 로그 (loguru + serialize)
- Q: 캐시 TTL 설정? → A: 1시간 (3600초)

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 동시 작업 안정성 향상 (Priority: P1)

시스템 운영자는 시세 수집, 신호 생성, 주문 실행, API 응답이 동시에 발생해도 시스템이 안정적으로 작동하기를 원한다. 현재 DB 커넥션 풀이 부족하여 동시 작업 시 일부 요청이 실패할 수 있다.

**Why this priority**: DB 커넥션 풀 고갈은 전체 시스템 장애로 이어질 수 있는 핵심 인프라 문제이며, 수정이 간단하여 즉시 적용 가능하다.

**Independent Test**: 동시에 여러 작업(시세 조회, 신호 생성, 대시보드 접속)을 실행하여 모든 요청이 성공적으로 처리되는지 확인.

**Acceptance Scenarios**:

1. **Given** 시스템이 정상 운영 중일 때, **When** 10개 이상의 동시 DB 작업이 발생하면, **Then** 모든 작업이 커넥션 대기 없이 처리된다.
2. **Given** 동시 작업 부하가 높을 때, **When** 커넥션 풀 상태를 확인하면, **Then** 사용 가능한 커넥션이 항상 존재한다.
3. **Given** 서버가 재시작되었을 때, **When** 즉시 여러 요청이 들어오면, **Then** 풀 초기화가 완료되어 정상 응답한다.

---

### User Story 2 - 설정값 조회 성능 개선 (Priority: P1)

시스템 운영자는 설정값(손절률, 포지션 크기 등) 조회 시 불필요한 DB 쿼리를 줄여 응답 속도를 개선하고 싶다. 현재 매번 DB를 조회하여 리소스를 낭비하고 있다.

**Why this priority**: 설정값은 거의 변경되지 않으므로 캐싱으로 DB 부하를 대폭 줄일 수 있으며, 신호 생성과 리스크 체크의 응답 속도가 개선된다.

**Independent Test**: 설정값 조회 API 호출 시 캐시 히트율과 DB 쿼리 횟수를 로그로 확인.

**Acceptance Scenarios**:

1. **Given** 설정값이 이미 조회된 상태에서, **When** 동일 설정값을 다시 조회하면, **Then** DB 쿼리 없이 캐시에서 반환된다.
2. **Given** 설정값이 캐시에 있을 때, **When** 관리자가 설정을 변경하면, **Then** 캐시가 무효화되고 다음 조회 시 DB에서 최신값을 가져온다.
3. **Given** 시스템이 1시간 동안 운영될 때, **When** 설정값 캐시 통계를 확인하면, **Then** 캐시 히트율이 95% 이상이다.

---

### User Story 3 - 데이터베이스 쿼리 성능 개선 (Priority: P1)

시스템 운영자는 주문 내역, 신호 내역 조회 시 더 빠른 응답을 원한다. 현재 인덱스 부재로 테이블 스캔이 발생하여 느리다.

**Why this priority**: 인덱스 추가는 저위험 고효율 최적화로, 쿼리 성능을 20-50% 개선할 수 있다.

**Independent Test**: 주문/신호 목록 API 응답 시간을 인덱스 추가 전후로 비교.

**Acceptance Scenarios**:

1. **Given** 1만 건 이상의 주문 데이터가 있을 때, **When** 특정 상태의 주문을 조회하면, **Then** 응답 시간이 인덱스 추가 전보다 개선된다.
2. **Given** 거래 신호 테이블에 많은 데이터가 있을 때, **When** market_data_id로 신호를 조회하면, **Then** 인덱스를 활용한 빠른 조회가 된다.
3. **Given** 인덱스가 추가된 상태에서, **When** EXPLAIN 쿼리를 실행하면, **Then** 인덱스 스캔이 사용됨을 확인할 수 있다.

---

### User Story 4 - 스케줄러 에러 복구 (Priority: P2)

시스템 운영자는 스케줄러 작업(시세 수집, 신호 생성)이 일시적 오류(Rate Limit, 네트워크 문제)로 실패해도 자동으로 복구되기를 원한다. 현재는 오류 발생 시 해당 주기를 건너뛰고 다음 주기까지 대기한다.

**Why this priority**: 안정성 향상으로 운영 중 수동 개입 필요성을 줄이고, 데이터 누락을 방지한다.

**Independent Test**: Rate Limit 오류를 시뮬레이션하여 재시도 후 성공하는지 확인.

**Acceptance Scenarios**:

1. **Given** 시세 수집 중 Rate Limit(429) 오류가 발생했을 때, **When** 재시도 로직이 실행되면, **Then** 지정된 대기 시간 후 재시도하여 성공한다.
2. **Given** 일시적 네트워크 오류가 발생했을 때, **When** 최대 재시도 횟수 내에 복구되면, **Then** 데이터 수집이 정상 완료된다.
3. **Given** 복구 불가능한 오류가 발생했을 때, **When** 최대 재시도 횟수를 초과하면, **Then** 상세 오류 로그가 기록되고 알림이 발송된다.

---

### User Story 5 - 시스템 상태 상세 모니터링 (Priority: P2)

시스템 운영자는 한눈에 시스템 상태(DB 연결, API 연결, 스케줄러, 최근 신호)를 파악하고 싶다. 현재 헬스체크는 단순 "ok" 응답만 제공한다.

**Why this priority**: 운영 가시성 향상으로 문제 조기 발견 및 진단 시간 단축.

**Independent Test**: 상세 헬스체크 API 호출 시 모든 구성 요소 상태가 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** 시스템이 정상 운영 중일 때, **When** 상세 헬스체크 API를 호출하면, **Then** DB, API, 스케줄러 상태가 모두 표시된다.
2. **Given** DB 연결에 문제가 있을 때, **When** 헬스체크를 호출하면, **Then** DB 상태가 "unhealthy"로 표시되고 원인이 명시된다.
3. **Given** 마지막 신호 생성 후 1시간이 경과했을 때, **When** 헬스체크를 호출하면, **Then** 경고 상태가 표시된다.

---

### User Story 6 - 메트릭 수집 및 모니터링 (Priority: P3)

시스템 운영자는 작업별 실행 시간, 성공률, API 응답 시간 등을 측정하여 성능 추이를 파악하고 싶다.

**Why this priority**: 장기적 성능 모니터링으로 잠재적 문제를 사전에 파악할 수 있다.

**Independent Test**: 메트릭 로그를 수집하여 대시보드에서 시각화되는지 확인.

**Acceptance Scenarios**:

1. **Given** 신호 생성 작업이 실행될 때, **When** 메트릭을 수집하면, **Then** 실행 시간, 토큰 사용량, 성공/실패 여부가 기록된다.
2. **Given** 하루 동안 메트릭이 수집되었을 때, **When** 통계를 조회하면, **Then** p50, p95, p99 응답 시간이 계산된다.
3. **Given** AI 호출 비용이 누적되었을 때, **When** 일일 비용을 조회하면, **Then** 총 토큰 사용량과 예상 비용이 표시된다.

---

### User Story 7 - 코드 품질 및 유지보수성 개선 (Priority: P3)

개발자는 코드 가독성과 유지보수성을 개선하고 싶다. 거대 함수 분리, 타입 정의 강화, 민감정보 마스킹 등이 필요하다.

**Why this priority**: 장기적 유지보수 비용 절감 및 버그 발생 가능성 감소.

**Independent Test**: 리팩토링 후 기존 테스트가 통과하고, 코드 커버리지가 유지되는지 확인.

**Acceptance Scenarios**:

1. **Given** 362줄의 거대 함수가 있을 때, **When** 작은 함수로 분리하면, **Then** 각 함수가 단일 책임을 가지고 테스트가 통과한다.
2. **Given** dict[str, Any] 반환 타입이 있을 때, **When** TypedDict로 변경하면, **Then** IDE에서 타입 힌트를 제공받을 수 있다.
3. **Given** 프롬프트 로깅 시 잔고 정보가 포함될 때, **When** 마스킹 함수를 적용하면, **Then** 로그에 민감정보가 노출되지 않는다.

---

### Edge Cases

- DB 커넥션 풀이 완전히 고갈되었을 때 어떻게 처리하는가?
  - 요청 대기열을 설정하고, 타임아웃 시 적절한 오류 메시지 반환
- 설정값 캐시가 오래되어 실제 값과 다를 때 어떻게 처리하는가?
  - 설정 변경 시 캐시 무효화 트리거, 또는 TTL(1시간) 이후 자동 갱신
- 스케줄러 재시도가 계속 실패할 때 어떻게 처리하는가?
  - 최대 3회 재시도 후 포기, 관리자에게 알림 발송, 다음 주기에 정상 재개

## Requirements *(mandatory)*

### Functional Requirements

**Phase 1 - 즉시 적용 (1일)**
- **FR-001**: 시스템은 DB 커넥션 풀 크기를 10/20 (min/max)으로 설정해야 한다.
- **FR-002**: 시스템은 주문/신호 테이블에 적절한 인덱스를 추가해야 한다.
- **FR-003**: 시스템은 DB 트랜잭션 격리 레벨을 명시적으로 설정해야 한다.

**Phase 2 - 1주일 내**
- **FR-004**: 시스템은 설정값 조회 시 TTL 1시간(3600초) 기반 캐시를 사용해야 한다.
- **FR-005**: 시스템은 앱 종료 시 HTTP 클라이언트를 정상적으로 종료해야 한다.
- **FR-006**: 시스템은 통계 계산을 가능한 DB에서 수행하여 데이터 전송을 최소화해야 한다.

**Phase 3 - 2주일 내**
- **FR-007**: 시스템은 스케줄러 작업 실패 시 지수 백오프 재시도(3회, 1초→2초→4초)를 수행해야 한다.
- **FR-008**: 시스템은 6개 구성요소(DB, Upbit API, Gemini API, 스케줄러, 최근 신호, 최근 주문) 상태를 보고하는 상세 헬스체크 엔드포인트를 제공해야 한다.
- **FR-009**: 시스템은 작업별 실행 시간, 성공률 등 메트릭을 구조화된 JSON 로그로 수집해야 한다.
- **FR-010**: AI 클라이언트는 Rate Limit(429) 응답 시 Retry-After 헤더를 준수해야 한다.

**코드 품질**
- **FR-011**: 시스템은 민감정보(잔고, API 키 등)를 로그에 마스킹해야 한다.
- **FR-012**: 에러 처리 시 조용히 실패하지 않고 최소한 경고 로그를 남겨야 한다.

### Key Entities

- **TTLCache**: 시간 기반 만료를 지원하는 캐시 (키, 값, 만료시간)
- **HealthStatus**: 시스템 구성요소별 상태 (DB, API, 스케줄러, 최근 활동)
- **JobMetric**: 스케줄러 작업 메트릭 (작업명, 실행시간, 성공여부, 타임스탬프)

### Assumptions

- 현재 DB 커넥션 풀 크기(5/10)는 동시성에 비해 작음
- 설정값은 빈번하게 변경되지 않으므로 1시간 TTL이 적절함
- 기존 테스트 코드가 있으며, 리팩토링 후에도 통과해야 함
- 메트릭 수집은 초기에 로깅 기반으로 시작하고, 필요시 Prometheus로 확장

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 동시 10개 이상의 DB 작업이 커넥션 대기 없이 처리된다.
- **SC-002**: 설정값 조회 시 캐시 히트율이 95% 이상이다.
- **SC-003**: 인덱스 추가 후 주문/신호 조회 쿼리 응답 시간이 20% 이상 개선된다.
- **SC-004**: 스케줄러 작업의 일시적 오류 복구율이 90% 이상이다.
- **SC-005**: 상세 헬스체크 API가 6개 구성요소(DB, Upbit API, Gemini API, 스케줄러, 최근 신호, 최근 주문) 상태를 보고한다.
- **SC-006**: 메트릭 수집으로 작업별 p95 응답 시간을 확인할 수 있다.
- **SC-007**: 테스트 커버리지가 80% 이상 유지된다.
