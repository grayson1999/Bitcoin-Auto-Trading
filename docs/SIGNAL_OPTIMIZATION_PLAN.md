# AI 신호 프롬프트 최적화 계획

> 작성일: 2026-01-24
> 상태: 계획 수립 완료

---

## 주요 변경사항 요약

| 항목 | 현재 | 변경 후 | 이유 |
|------|:----:|:-------:|------|
| 신호 생성 주기 | 1시간 | **30분** | 변동성 대응 강화 |
| 시장 데이터 조회 | 168시간 (1000개) | **샘플링 기반** | 시간대별 적정 간격 |
| 데이터 샘플링 | 없음 (전체 로드) | **시간대별 샘플링** | 토큰 90% 절감 |
| 성과 피드백 | 포함 | **제거** | 대시보드에서 확인 |
| 프롬프트 토큰 | ~10,000 | **~4,000** | 60% 절감 |
| 일일 비용 (48회) | ~₩960 | **~₩400** | 비용 효율화 |

---

## 현재 문제점 분석

### 1. 프롬프트 길이 과다 (~10,000 토큰)

| 구성요소 | 현재 토큰 | 문제 |
|---------|:---------:|------|
| 시스템 프롬프트 | ~3,500 | 중복 규칙 반복 |
| 분석 프롬프트 | ~6,000 | 불필요한 상세 정보 |
| 성과 피드백 | ~500 | **제거 대상** |
| **합계** | **~10,000** | 비용/지연 증가 |

### 2. 시장 데이터 과다 조회 (샘플링 미적용)

**현재 코드:** `service.py:248-256`
```python
SIGNAL_MARKET_DATA_HOURS = 168  # 7일
.limit(1000)  # 최대 1000개 전체 로드
```

**문제:**
- 10초마다 시세 수집 → 1시간에 360개, 하루 8,640개
- 7일치 데이터 (1000개) 전체 조회 후 프롬프트에 전달
- **샘플링 없이 모든 데이터를 AI에 전달** → 토큰 낭비
- 실제 필요: 시간대별 샘플링된 대표 데이터만

### 3. 성과 피드백 불필요

**현재:** `service.py:159-165`, `builder.py:225-251`
- 매번 30개 신호 성과 분석
- 프롬프트에 상세 피드백 포함
- **일일/누적 손익에서 확인 가능 → 제거**

### 4. 신뢰도(confidence) 부정확

**현재 문제:**
- AI가 조건 불명확 시 기본값 0.5 출력
- 시스템 프롬프트의 신뢰도 기준표가 명확하지 않음
- 체크리스트 형식이 AI 혼란 유발

---

## 최적화 계획

### Phase 1: 성과 피드백 제거 (즉시)

**제거 대상 파일:**
- `signal/service.py:159-165` - perf_tracker 호출 제거
- `signal/prompt/builder.py:84` - performance_feedback 제거
- `signal/prompt/builder.py:225-251` - `_format_performance_feedback()` 제거
- `signal/prompt/templates.py:450-451` - 프롬프트에서 성과 피드백 섹션 제거

**효과:** ~500 토큰 절감

---

### Phase 2: 시장 데이터 샘플링 최적화

**현재 문제:**
```python
SIGNAL_MARKET_DATA_HOURS = 168  # 7일
.limit(1000)  # 10초 간격 데이터 1000개 전체 로드
```

**변경: 시간대별 샘플링 전략**

| 시간대 | 용도 | 샘플링 간격 | 데이터 수 |
|--------|------|:-----------:|:---------:|
| 장기 (14일) | 장기 추세 파악 | 1시간 | ~336개 |
| 중기 (24시간) | 일간 변동성 | 15분 | ~96개 |
| 단기 (1시간) | 최근 가격 흐름 | 5분 | ~12개 |
| **합계** | | | **~450개** |

**구현 방식:**
```python
# 샘플링 설정
SAMPLING_CONFIG = {
    "long_term": {
        "hours": 336,      # 14일
        "interval_min": 60  # 1시간 간격
    },
    "mid_term": {
        "hours": 24,       # 1일
        "interval_min": 15  # 15분 간격
    },
    "short_term": {
        "hours": 1,        # 1시간
        "interval_min": 5   # 5분 간격
    }
}

# 샘플링 쿼리 (예시)
def get_sampled_market_data(currency: str, hours: int, interval_min: int):
    """interval_min 간격으로 샘플링된 데이터 조회"""
    # ROW_NUMBER() OVER (PARTITION BY time_bucket) 활용
    # 또는 Python에서 후처리로 N번째 데이터만 추출
```

**효과:**
- 현재: 1000개 전체 로드 → 토큰 과다 사용
- 변경: ~450개 샘플링 → **55% 데이터 절감**
- 프롬프트에는 요약 통계만 전달 (추가 압축 가능)

---

### Phase 3: 프롬프트 압축 (50% 절감 목표)

#### 3.1 시스템 프롬프트 간소화

**현재 (3,500 토큰):**
- 손절 규칙 3번 반복
- 포지션별 상세 테이블
- 신뢰도 기준표 중복

**최적화 (1,500 토큰 목표):**
```markdown
당신은 {currency} 단기 트레이딩 AI입니다.

## 전략 특성
- **30분 주기** 신호 생성 → 공격적 단기 매매
- 빠른 진입/청산 우선, 장기 보유 지양
- 변동성 활용한 스캘핑/스윙 전략

## 핵심 규칙 (우선순위 순)
1. 손절: 미실현 손실 >= {stop_loss}% → SELL (신뢰도 0.9)
2. 익절: 미실현 이익 >= {take_profit}% AND 하락 신호 → SELL
3. 매수: Confluence >= {min_confluence} AND RSI < {rsi_overbought} → BUY
4. 기타 → HOLD

## 신뢰도 계산 (필수 - 공식 적용)
base = 손절시 0.9, 익절시 0.85, 매수시 0.6, HOLD시 0.5
tf_bonus = 4TF일치 +0.15, 3TF +0.10, 2TF +0.05
indicator_bonus = RSI극단 +0.05, MACD+BB일치 +0.05
confidence = min(1.0, base + tf_bonus + indicator_bonus)

## 출력 (JSON만)
{"signal": "BUY|HOLD|SELL", "confidence": 0.0~1.0, "reasoning": "..."}
```

#### 3.2 분석 프롬프트 간소화

**현재 (6,000 토큰):**
- 8개 섹션
- 체크리스트 형식 (AI 혼란)
- 성과 피드백 포함

**최적화 (2,500 토큰 목표):**
```markdown
## {currency} 분석 ({timestamp})

**현재가:** {price} KRW ({change}%)

**포지션:**
- 잔고: {krw} KRW, {coin} {currency}
- 평단: {avg_price} → 미실현: {pnl_pct}%
- 손절가: {stop_loss} (조건 충족: YES/NO)

**지표 (1D):**
RSI={rsi}, MACD={macd_signal}, BB%={bb_pct}%, EMA={alignment}

**MTF 분석:**
1H={trend}, 4H={trend}, 1D={trend}, 1W={trend}
합류점수: {confluence}/1.0, 편향: {bias}

→ 위 데이터로 신호 생성 (JSON)
```

---

### Phase 4: 신뢰도 정확도 개선

**문제:** AI가 조건 불명확 시 기본값 0.5 출력

**해결책:**

1. **명시적 계산 공식 제공:**
```
신뢰도 = 기본값 + TF보너스 + 지표보너스

기본값:
- 손절 조건 충족: 0.9
- 익절 조건 충족: 0.85
- 매수 조건 충족: 0.6
- HOLD: 0.5

TF보너스 (같은 방향 TF 개수):
- 4개: +0.15
- 3개: +0.10
- 2개: +0.05
- 1개: +0.00

지표보너스:
- RSI 과매도/과매수 극단: +0.05
- MACD + BB 일치: +0.05
```

2. **출력 형식에 계산 근거 요구:**
```json
{
  "signal": "BUY",
  "confidence": 0.75,
  "confidence_breakdown": {
    "base": 0.6,
    "tf_bonus": 0.10,
    "indicator_bonus": 0.05
  },
  "reasoning": "..."
}
```

---

## 수정 대상 파일 요약

| 파일 | 수정 내용 | 우선순위 |
|------|---------|:--------:|
| `config/settings.py:93-98` | signal_interval_hours → signal_interval_minutes (30) | **높음** |
| `scheduler/scheduler.py:82-91` | IntervalTrigger(hours=) → minutes= | **높음** |
| `config/constants.py` | 샘플링 설정 추가 (SAMPLING_CONFIG) | 높음 |
| `signal/service.py` | 샘플링 쿼리 로직 구현 | 높음 |
| `signal/service.py:159-165` | 성과 피드백 호출 제거 | 높음 |
| `signal/prompt/builder.py:84` | performance_feedback 제거 | 높음 |
| `signal/prompt/builder.py:225-251` | `_format_performance_feedback()` 제거 | 높음 |
| `signal/prompt/templates.py:91-229` | 시스템 프롬프트 압축 + 30분 주기 명시 | 중간 |
| `signal/prompt/templates.py:427-481` | 분석 프롬프트 압축 | 중간 |
| `signal/prompt/templates.py` | 신뢰도 계산 공식 추가 | 중간 |

---

## 예상 효과

| 항목 | 현재 | 최적화 후 | 개선율 |
|------|:----:|:---------:|:------:|
| 신호 생성 주기 | 1시간 (24회/일) | **30분 (48회/일)** | 2배 빈번 |
| 입력 토큰 | ~10,000 | ~4,000 | 60%↓ |
| 비용 (Gemini) | ₩20/회 | ₩8/회 | 60%↓ |
| 일일 비용 | ₩480 (24회) | **₩400 (48회)** | 빈도↑ 비용↓ |
| 응답 시간 | 5-8초 | 2-4초 | 50%↓ |
| 시장 데이터 조회 | 1000개 (전체) | ~450개 (샘플링) | 55%↓ |
| 변동성 대응 | 1시간 후 | **30분 후** | 2배 빠름 |
| 신뢰도 정확도 | 불명확 | 계산식 기반 | 향상 |

---

## 구현 순서

### 1단계: 신호 주기 변경 (5분)
- [ ] `settings.py`: signal_interval_hours → signal_interval_minutes = 30
- [ ] `scheduler.py`: IntervalTrigger(minutes=signal_interval_minutes)
- [ ] DB_OVERRIDABLE_KEYS 업데이트

### 2단계: 시장 데이터 샘플링 구현 (15분)
- [ ] `constants.py`: SAMPLING_CONFIG 추가 (장기/중기/단기 설정)
- [ ] `signal/service.py`: 샘플링 쿼리 로직 구현
  - 장기 (14일, 1시간 간격) → ~336개
  - 중기 (24시간, 15분 간격) → ~96개
  - 단기 (1시간, 5분 간격) → ~12개
- [ ] 프롬프트에 샘플링된 데이터 요약만 전달

### 3단계: 성과 피드백 제거 (10분)
- [ ] `service.py`: perf_tracker 관련 코드 제거
- [ ] `builder.py`: performance_feedback 제거
- [ ] `templates.py`: 프롬프트에서 섹션 6 제거
- [ ] `scheduler.py`: evaluate_signal_performance_job 제거 검토

### 4단계: 프롬프트 압축 (30분)
- [ ] 시스템 프롬프트 간소화
- [ ] **30분 주기 공격적 트레이딩 명시**
- [ ] 분석 프롬프트 간소화
- [ ] 신뢰도 계산 공식 추가

### 5단계: 테스트
- [ ] 신호 생성 테스트 (30분 주기 확인)
- [ ] 토큰 사용량 확인 (~4,000 목표)
- [ ] 신뢰도 분포 확인 (0.5 고정 비율)

---

## 비용 분석 (30분 주기)

### 현재 vs 최적화 후

| 항목 | 현재 (1시간) | 최적화 후 (30분) |
|------|:-----------:|:---------------:|
| 일일 신호 생성 | 24회 | 48회 |
| 토큰/회 | ~10,000 | ~4,000 |
| 비용/회 (Gemini) | ₩20 | ₩8 |
| **일일 비용** | **₩480** | **₩384** |
| **월간 비용** | **₩14,400** | **₩11,520** |

→ **신호 2배 빈번 + 비용 20% 절감**

### 30분 주기 장점

1. **변동성 대응**: 급등/급락 30분 내 반응
2. **기회 포착**: 단기 추세 빠르게 캐치
3. **손실 최소화**: 손절 신호 더 빨리 생성
4. **공격적 매매**: 스캘핑/스윙 전략 가능

---

## 추가 고려사항

### 성과 피드백 대안
- 대시보드에서 일일/누적 손익 표시
- 별도 분석 리포트 생성 (필요 시)

### 신뢰도 검증
- 최적화 후 1주일간 신뢰도 분포 모니터링
- 0.5 고정 출력 비율 추적

### 롤백 계획
- 기존 프롬프트 백업 (`templates.py.bak`)
- 문제 발생 시 즉시 롤백
